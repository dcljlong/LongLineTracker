<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Long Line Tracker</title>

<link rel="icon" href="./favicon.ico" />
<link rel="stylesheet" href="./style.css" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>

<div class="app-shell">

  <!-- Slim rail -->
  <aside class="rail">

    <!-- DEV MARK (max for column, independent from green) -->
    <div class="rail-dev" title="Long Line Tracker">
      <img class="rail-dev-logo" src="./app-logo.png" alt="Long Line Tracker logo" />
      <div class="rail-dev-name">LLT</div>
    </div>

    <!-- HOME BUTTON (green hardhat = Dashboard) -->
    <button class="rail-home is-active" data-page="dashboard" title="Home / Dashboard">
      <i class="fas fa-hard-hat"></i>
    </button>

    <!-- Only ONE extra nav item in rail: Calendar (remove duplicate Dashboard button) -->
    <button class="rail-btn" data-page="calendar" title="Calendar">
      <i class="fas fa-calendar-alt"></i>
    </button>

    <div class="rail-spacer"></div>

    <div class="rail-badge" title="Company">
      <span id="railBadge">CU</span>
    </div>
  </aside>

  <div class="app-main">

    <!-- Top header -->
    <header class="topbar">

      <!-- Company logo only (tight frame) -->
      <div class="topbar-left">
        <div class="company-logo-wrap" aria-label="Company logo">
          <img id="companyLogo" class="company-logo" src="./company-logo.png" alt="Company logo" />
        </div>
      </div>

      <!-- Primary navigation (single source of truth for tabs) -->
      <nav class="top-tabs" role="tablist" aria-label="Primary navigation">
        <button class="tab is-active" data-page="dashboard">
          <i class="fas fa-chart-pie"></i><span>Dashboard</span>
        </button>
        <button class="tab" data-page="calendar">
          <i class="fas fa-calendar-alt"></i><span>Calendar</span>
        </button>
      </nav>

      <div class="topbar-right">
        <div class="clock">
          <i class="fas fa-clock"></i>
          <span id="liveDate">--</span>
        </div>

        <div class="header-kpis" aria-label="Header KPIs">
          <div class="hkpi">
            <div class="hkpi-num" id="hk_total">0</div>
            <div class="hkpi-lbl">Assets</div>
          </div>
          <div class="hkpi warn">
            <div class="hkpi-num" id="hk_due">0</div>
            <div class="hkpi-lbl">Due</div>
          </div>
          <div class="hkpi danger">
            <div class="hkpi-num" id="hk_overdue">0</div>
            <div class="hkpi-lbl">Overdue</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="content">

      <!-- DASHBOARD -->
      <section id="dashboard-page" class="page is-active">
        <div class="page-head">
          <h2>Operations Dashboard</h2>
          <div class="page-actions">
            <div class="search">
              <i class="fas fa-magnifying-glass"></i>
              <input id="quickSearch" type="text" placeholder="Search assets (name / ID / person)..." />
            </div>
          </div>
        </div>

        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-top"><span class="kpi-icon"><i class="fas fa-boxes-stacked"></i></span><span class="kpi-title">Total Equipment</span></div>
            <div class="kpi-value" id="k_total">0</div>
            <div class="kpi-foot">All tracked assets</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-top"><span class="kpi-icon"><i class="fas fa-person-digging"></i></span><span class="kpi-title">Active Checkouts</span></div>
            <div class="kpi-value" id="k_inuse">0</div>
            <div class="kpi-foot">Currently assigned</div>
          </div>

          <div class="kpi-card warn">
            <div class="kpi-top"><span class="kpi-icon"><i class="fas fa-hourglass-half"></i></span><span class="kpi-title">Due This Week</span></div>
            <div class="kpi-value" id="k_due">0</div>
            <div class="kpi-foot">Return window risk</div>
          </div>

          <div class="kpi-card danger">
            <div class="kpi-top"><span class="kpi-icon"><i class="fas fa-triangle-exclamation"></i></span><span class="kpi-title">Overdue</span></div>
            <div class="kpi-value" id="k_overdue">0</div>
            <div class="kpi-foot">Immediate follow-up</div>
          </div>
        </div>

        <div class="board">
          <div class="col available">
            <div class="col-head">
              <div class="col-title">Available</div>
              <div class="col-badge" id="c_available">0</div>
            </div>
            <div class="col-body" id="list_available"></div>
          </div>

          <div class="col inuse">
            <div class="col-head">
              <div class="col-title">In Use</div>
              <div class="col-badge" id="c_inuse">0</div>
            </div>
            <div class="col-body" id="list_inuse"></div>
          </div>

          <div class="col returndue">
            <div class="col-head">
              <div class="col-title">Return Due</div>
              <div class="col-badge" id="c_due">0</div>
            </div>
            <div class="col-body" id="list_due"></div>
          </div>

          <div class="col overdue">
            <div class="col-head">
              <div class="col-title">Overdue</div>
              <div class="col-badge" id="c_overdue">0</div>
            </div>
            <div class="col-body" id="list_overdue"></div>
          </div>
        </div>
      </section>

      <!-- CALENDAR -->
      <section id="calendar-page" class="page">
        <div class="page-head">
          <h2>Schedule Calendar</h2>
          <div class="page-actions">
            <button class="btn" id="btnToday"><i class="fas fa-location-crosshairs"></i> Today</button>
          </div>
        </div>

        <div class="calendar-wrap">
  <div class="mini-months" aria-label="Mini month ribbon">
  <button class="mm-nav mm-prev" id="mmPrev" title="Previous month"><i class="fas fa-chevron-left"></i></button>

  <div class="mini-month" id="miniM2" aria-label="Two months back"></div>
  <div class="mini-month" id="miniM1" aria-label="Previous month"></div>
  <div class="mini-month is-selected" id="miniM0" aria-label="Selected month"></div>
  <div class="mini-month" id="miniP1" aria-label="Next month"></div>
  <div class="mini-month" id="miniP2" aria-label="Two months ahead"></div>

  <button class="mm-nav mm-next" id="mmNext" title="Next month"><i class="fas fa-chevron-right"></i></button>
</div>
<div id="calendar"></div>
        </div>
      </section>

    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
const BRANDING = {
  railBadge: "CU",
  companyLogoPath: "./company-logo.png"
};

let _cal = null;

function updateClock(){
  const now = new Date();
  const el = document.getElementById("liveDate");
  if (!el) return;

  const fmt = new Intl.DateTimeFormat(undefined, {
    weekday: "short",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit"
  });

  el.textContent = fmt.format(now);
}
setInterval(updateClock, 1000);
updateClock();

function applyBranding(){
  const rb = document.getElementById("railBadge");
  if (rb) rb.textContent = BRANDING.railBadge || "CO";

  const cLogo = document.getElementById("companyLogo");
  if (cLogo) cLogo.src = BRANDING.companyLogoPath;
}

function setActivePage(page){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("is-active"));
  document.getElementById(page + "-page").classList.add("is-active");

  document.querySelectorAll(".tab").forEach(b => b.classList.toggle("is-active", b.dataset.page === page));
  document.querySelectorAll(".rail-btn").forEach(b => b.classList.toggle("is-active", b.dataset.page === page));
  document.querySelectorAll(".rail-home").forEach(b => b.classList.toggle("is-active", page === "dashboard"));

  if (page === "calendar") startCalendar();
}

document.addEventListener("click", (e) => {
  const tab = e.target.closest(".tab");
  const railBtn = e.target.closest("button");
  if (tab && tab.dataset.page) setActivePage(tab.dataset.page);
  if (railBtn && railBtn.dataset.page) setActivePage(railBtn.dataset.page);
});

/* ===== Calendar persistence (LocalStorage) ===== */
const CAL_STORAGE_KEY = "LLT_CAL_EVENTS_V1";

function loadCalEvents(){
  try{
    const raw = localStorage.getItem(CAL_STORAGE_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  }catch(e){
    return [];
  }
}

function saveCalEvents(cal){
  try{
    const events = cal.getEvents().map(ev => ({
      id: ev.id || undefined,
      title: ev.title || "",
      start: ev.start ? ev.start.toISOString() : null,
      end: ev.end ? ev.end.toISOString() : null,
      allDay: !!ev.allDay
    }));
    localStorage.setItem(CAL_STORAGE_KEY, JSON.stringify(events));
  }catch(e){
    // no-op
  }
}
/* ===== end persistence ===== */

/* ===== Mini month previews logic ===== */
function renderMiniMonth(containerId, year, monthIndex, focusDate){
  const el = document.getElementById(containerId);
  if(!el) return;

  const monthStart = new Date(year, monthIndex, 1);
  const monthEnd = new Date(year, monthIndex + 1, 0);
  const today = new Date();

  const titleFmt = new Intl.DateTimeFormat(undefined, { month:"long", year:"numeric" });
  const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  // start grid on Sunday
  const gridStart = new Date(year, monthIndex, 1);
  gridStart.setDate(gridStart.getDate() - gridStart.getDay());

  let html = '';
  html += '<div class="mm-head">';
  html += '  <div class="mm-title" data-goto="' + monthStart.toISOString() + '">' + titleFmt.format(monthStart) + '</div>';
  html += '</div>';
  html += '<table><thead><tr>' + dow.map(d => '<th>'+d.substring(0,2)+'</th>').join('') + '</tr></thead><tbody>';

  let cur = new Date(gridStart);
  for(let wk=0; wk<6; wk++){
    html += '<tr>';
    for(let d=0; d<7; d++){
      const inMonth = (cur.getMonth() === monthIndex);
      const isOut = !inMonth;
      const isToday = cur.toDateString() === today.toDateString();
      const isFocus = focusDate && cur.toDateString() === focusDate.toDateString();

      const cls = [
        isOut ? "is-out" : "",
        isToday ? "is-today" : "",
        isFocus ? "is-focus" : ""
      ].filter(Boolean).join(" ");

      const iso = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()).toISOString();

      if(isOut){
        html += '<td class="'+cls+'">' + cur.getDate() + '</td>';
      }else{
        html += '<td class="'+cls+'" data-goto="' + iso + '">' + cur.getDate() + '</td>';
      }
      cur.setDate(cur.getDate()+1);
    }
    html += '</tr>';
  }
  html += '</tbody></table>';

  el.innerHTML = html;

  // click to goto date
  el.querySelectorAll('[data-goto]').forEach(n => {
    n.addEventListener('click', () => {
      if(!_cal) return;
      const dt = new Date(n.getAttribute('data-goto'));
      _cal.gotoDate(dt);
    
      if (typeof updateMiniMonths === "function") { updateMiniMonths(); }
});
  });
}

function updateMiniMonths(){
  if(!_cal) return;

  const focus = _cal.getDate();
  const y = focus.getFullYear();
  const m = focus.getMonth();

  // clear selected state
  ["miniM2","miniM1","miniM0","miniP1","miniP2"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.classList.remove("is-selected");
  });
  const center=document.getElementById("miniM0");
  if(center) center.classList.add("is-selected");

  const slots = [
    { id:"miniM2", off:-2 },
    { id:"miniM1", off:-1 },
    { id:"miniM0", off: 0 },
    { id:"miniP1", off: 1 },
    { id:"miniP2", off: 2 }
  ];

  slots.forEach(s=>{
    const dt = new Date(y, m + s.off, 1);
    renderMiniMonth(s.id, dt.getFullYear(), dt.getMonth(), focus);
  });
}

// ribbon nav buttons move the MAIN calendar month
function wireMiniMonthNav(){
  const prev = document.getElementById("mmPrev");
  const next = document.getElementById("mmNext");
  if(prev && !prev.dataset.wired){
    prev.addEventListener("click", ()=>{
      if(!_cal) return;
      const f=_cal.getDate();
      _cal.gotoDate(new Date(f.getFullYear(), f.getMonth()-1, 1));
    });
    prev.dataset.wired="1";
  }
  if(next && !next.dataset.wired){
    next.addEventListener("click", ()=>{
      if(!_cal) return;
      const f=_cal.getDate();
      _cal.gotoDate(new Date(f.getFullYear(), f.getMonth()+1, 1));
    });
    next.dataset.wired="1";
  }

  // optional wheel scroll on ribbon
  const ribbon = document.querySelector(".mini-months");
  if(ribbon && !ribbon.dataset.wired){
    let t=0;
    ribbon.addEventListener("wheel",(e)=>{
      if(Math.abs(e.deltaY) < 5) return;
      e.preventDefault();
      const now=Date.now();
      if(now - t < 250) return;
      t = now;
      const f=_cal?.getDate?.();
      if(!f) return;
      const dir = e.deltaY > 0 ? 1 : -1;
      _cal.gotoDate(new Date(f.getFullYear(), f.getMonth()+dir, 1));
    },{passive:false});
    ribbon.dataset.wired="1";
  }
}
/* ===== end mini months ===== */

function startCalendar(){
  const calEl = document.getElementById("calendar");
  if (!calEl || _cal) return;

  _cal = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    
    dayMaxEventRows: true,
    moreLinkClick: "popover",
height: "100%",
    expandRows: true,
    headerToolbar: { left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    selectable: true,
    editable: true,
    nowIndicator: true,
    events: loadCalEvents(),
    select(info){
      const t = prompt("Event title:");
      if (t) _cal.addEvent({ title: t, start: info.startStr, end: info.endStr, allDay: info.allDay });
    
      saveCalEvents(_cal); applyCalendarDensity();
},
    eventClick(info){
      if (confirm("Delete this event?")) info.event.remove();
    
      saveCalEvents(_cal); applyCalendarDensity();
}
    ,eventChange() { saveCalEvents(_cal); applyCalendarDensity(); }
  });

  _cal.render();

  
  if (typeof updateMiniMonths === "function") { updateMiniMonths(); setTimeout(updateMiniMonths, 50); }
const btnToday = document.getElementById("btnToday");
  if (btnToday) btnToday.addEventListener("click", () => _cal.today());
}

applyBranding();
</script>

</body>
</html>



<script>

/* ===== Calendar Auto Density Logic ===== */
function applyCalendarDensity(){
  if (!_cal) return;

  const calEl = document.querySelector('.fc');
  if (!calEl) return;

  const total = _cal.getEvents().length;

  calEl.classList.remove('dense','super-dense');

  if (total > 40){
    calEl.classList.add('super-dense');
  } else if (total > 20){
    calEl.classList.add('dense');
  }
}

/* Hook into calendar lifecycle */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => applyCalendarDensity(), 800);
});

</script>











